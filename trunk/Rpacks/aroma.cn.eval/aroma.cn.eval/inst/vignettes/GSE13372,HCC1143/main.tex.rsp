%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Author: Henrik Bengtsson, hb@stat.berkeley.edu
% Created on: 2009-02-23
%
% Usage:
%  library("R.rsp");
%  rsptex("main.tex.rsp");  # => *.tex.rsp => ... => *.dvi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
<%
title <- "Evaluation GSE13372,HCC1143";
authors <- "Henrik Bengtsson";
figPath <- "figures/col/";
figForce <- FALSE;
figDev <- function(..., force=figForce) { epsDev(..., path=figPath, force=force) }
%>

\documentclass[a4paper]{article}
\usepackage{graphicx}
\usepackage{fancyvrb}
\usepackage{a4wide}

% The search path (within curly brackets and separated by commas)
% where to find graphics files
\graphicspath{{<%=figPath%>}}
\DeclareGraphicsRule{.eps.gz}{eps}{.eps.bb}{`gunzip -c #1}

\title{<%=title%>}
\author{<%=authors%>}

\begin{document}

\maketitle

<%
sourceDirectory("R/");
%>

\section{Dataset}
\begin{itemize}
  \item Data set: GSE13372
  \item Samples: HCC1143, HCC1143BL
\end{itemize}

\begin{Verbatim}[fontfamily=helvetica]
<%={x <- capture.output(print(dsList));x <- gsub(": .*/(rawCnData/)", ": \\1", x);paste(x, collapse="\n");}%>
\end{Verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BEGIN Regions of interest
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
<% for (region in regions) { %>
\clearpage
\subsection{Region: <%=region%>}

<%
print(region);
region <- parseRegion(region);
print(region);
cnList <- NULL;
%>


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BEGIN Figure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
<%
figName <- sprintf("%s,track", region$label);
if (fig <- figDev(figName)) {

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
# Plot CN ratios along genome
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
cnList <- getCnList(cnList);
print(cnList);

nbrOfSources <- length(cnList);
subplots(nbrOfSources, ncol=1);
par(mar=c(3,3,0.5,0.5)+0.1);
pch <- 19; cex <- 0.7;
pch <- "."; cex <- 2;
pch <- 176; cex <- 0.8;
xRange <- range(sapply(cnList, FUN=xRange));
states <- na.omit(sort(unique(getStates(cnList[[1]]))));

for (kk in seq(along=cnList)) {
  cn <- cnList[[kk]];
  name <- names(cnList)[kk];
  plot(cn, pch=pch, cex=1*cex, xlim=xRange);
  sd <- estimateStandardDeviation(cn);
  stext(side=3, pos=0.5, line=-1.5, cex=0.8, sprintf("SD=%.3g", sd));
  stext(side=3, pos=0.02, line=-1.5, cex=1.0, name);
  if (kk == 1) {
    stext(side=3, pos=0.98, line=-1.5, cex=0.8, sprintf("Chr%02d", getChromosome(cn)));
  }
  binWidth <- 3e3;
  cn <- extractSubsetByState(cn, states=states);
  cnS <- binnedSmoothingByState(cn, from=xRange[1], to=xRange[2], by=binWidth);
  points(cnS, pch=pch, cex=0.8*cex, col="white");
  points(cnS, pch=pch, cex=0.6*cex, col="orange");  
} # for (kk ...)
devDone(figName);
} # if (figDev(...))
%>
\begin{figure}[htb]
 \begin{center}
  \resizebox{0.8\textwidth}{!}{\includegraphics{<%=fig$fullname%>}}
 \end{center}
 \caption{<%=region$src%>}
 \label{fig<%=figName%>}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% END Figure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BEGIN Figure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
<%
figName <- sprintf("%s,ROC", region$label);
if (fig <- figDev(figName)) {

cnList <- getCnList(cnList);
print(cnList);

xRange <- range(sapply(cnList, FUN=xRange));
states <- na.omit(sort(unique(getStates(cnList[[1]]))));

binWidths <- c(0,1,2,5)*1e3;
layout(matrix(seq(along=binWidths), ncol=2, byrow=TRUE));
par(mar=c(3,3,2,1)+0.1, mgp=c(1.4,0.4,0));
fpLim <- c(0,0.50);
for (ww in seq(along=binWidths)) {
  binWidth <- binWidths[ww];

  if (binWidth > 0) {
    # Smooth CNs using consecutive bins of given width (in kb)
    cnSList <- lapply(cnList, FUN=function(cn) {
      cnS <- binnedSmoothingByState(cn, from=xRange[1], to=xRange[2], by=binWidth);
      cnS <- extractSubsetByState(cnS, states=states);
      cnS;
    }) 
    binLabel <- sprintf("Bin width %g kb", binWidth/1e3);
  } else {
    cnSList <- cnList;
    binLabel <- sprintf("Full resolution");
  }
  print(cnSList);

  fits <- lapply(cnSList, FUN=function(cnS) {
    cat("Number of missing values: ", sum(is.na(cnS$cn)), "\n", sep="");
    fitRoc(cnS, states=states, recall=states[1]);
  });

  for (kk in seq(along=fits)) {
    fit <- fits[[kk]];
    roc <- fit$roc;
    if (kk == 1) {
      plot(roc, type="l", lwd=3, col=kk, xlim=fpLim, ylim=sort(1-fpLim));
      abline(a=0, b=1, lty=3);
      stext(side=3, pos=1, binLabel);
    } else {
      lines(roc, lwd=3, col=kk);
    }
    if (kk == 1) {
      labels <- strsplit(names(cnSList), split="\n");
      labels <- sapply(labels, FUN=function(s) s[1]);
      legend("bottomright", col=seq(along=labels), pch=19, labels, cex=0.8, bty="n");
    }
  } # for (kk ...)
} # for (ww ...)
  devDone(figName);
} # if (figDev(...))
%>
\begin{figure}[htb]
 \begin{center}
  \resizebox{0.8\textwidth}{!}{\includegraphics{<%=fig$fullname%>}}
 \end{center}
 \caption{<%=region$src%>}
 \label{fig<%=figName%>}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% END Figure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


<% } # for (region in regions) %>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% END Regions of interest
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Session information
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{Session information}
<%=toLatex(sessionInfo())%>


\end{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% HISTORY:
% 2009-02-23
% o Created.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
