# https://tcga-data.nci.nih.gov/tcgafiles/ftp_auth/distro_ftpusers/tcga4yeo/tumor/ov/cgcc/broad.mit.edu/genome_wide_snp_6/snp/broad.mit.edu_OV.Genome_Wide_SNP_6.12.5.0/MANIFEST.txt# http://tcga-data.nci.nih.gov/tcgafiles/ftp_auth/distro_ftpusers/anonymous/setConstructorS3("TcgaDccDownloader", function(urlPath=NULL, rootUrl="tcga-data.nci.nih.gov/tcgafiles/ftp_auth/distro_ftpusers/", protocol=c("auto", "https","http"), username=NULL, password=NULL, ...) {  # Argument 'protocol':  protocol <- match.arg(protocol);  extend(Object(), "TcgaDccDownloader",    .protocol = protocol,    .username = username,    .password = password,    .rootUrl = rootUrl,    .urlPath = urlPath  )})setMethodS3("as.character", "TcgaDccDownloader", function(x, ...) {  # To please R CMD check   this <- x;  s <- sprintf("%s:", class(this)[1]);  s <- c(s, sprintf("Protocol: %s", getProtocol(this)));  s <- c(s, sprintf("Root URL: %s", getRootUrl(this)));  s <- c(s, sprintf("URL path: %s", getUrlPath(this)));  s <- c(s, sprintf("Root path: %s", getRootPath(this)));  class(s) <- "GenericSummary";   s;})setMethodS3("getRootPath", "TcgaDccDownloader", function(this, ...) {  "tcgaData";})setMethodS3("getProtocol", "TcgaDccDownloader", function(this, ...) {  protocol <- this$.protocol;  if (protocol == "auto") {    path <- getUrlPath(this);    path <- strsplit(path, split="/", fixed=TRUE)[[1]];    path <- path[1];    if (path %in% c("tcga4yeo")) {      protocol <- "https";    } else {      protocol <- "http";    }  }  protocol;})setMethodS3("getUsername", "TcgaDccDownloader", function(this, ...) {  this$.username;})setMethodS3("setUsername", "TcgaDccDownloader", function(this, value, ...) {  this$.username <- value;  this;})setMethodS3("getPassword", "TcgaDccDownloader", function(this, ...) {  this$.password;})setMethodS3("setPassword", "TcgaDccDownloader", function(this, value, ...) {  this$.password <- value;  this;})setMethodS3("setLogin", "TcgaDccDownloader", function(this, username, password, ...) {  setUsername(this, username);  setPassword(this, password);})setMethodS3("getRootUrl", "TcgaDccDownloader", function(this, ...) {  this$.rootUrl;})setMethodS3("getUrlPath", "TcgaDccDownloader", function(this, ...) {  this$.urlPath;})setMethodS3("getUrlPathname", "TcgaDccDownloader", function(this, filename, ...) {  filename <- Arguments$getCharacter(filename);  url <- paste(c(getRootUrl(this), getUrlPath(this), filename), collapse="/");  url <- gsub("//", "/", url);  url;})setMethodS3("getUrl", "TcgaDccDownloader", function(this, ...) {  protocol <- getProtocol(this);  pathname <- getUrlPathname(this, ...);  url <- sprintf("%s://%s", protocol, pathname);  url;})setMethodS3("downloadUrl", "TcgaDccDownloader", function(this, url, filename=NULL, path=NULL, ..., skip=TRUE, overwrite=!skip) {  # Argument 'url':  url <- Arguments$getCharacter(url);  # Argument 'filename' & 'path':  if (is.null(filename)) {    filename <- basename(url);  }  if (is.null(path)) {    path <- file.path(getRootPath(this), getUrlPath(this));  }  pathname <- Arguments$getWritablePathname(filename, path=path,                                                      mustNotExist=FALSE);  if (isFile(pathname)) {    fi <- file.info(pathname);    if (!is.na(fi$size) && fi$size == 0) {      file.remove(pathname);    } else if (skip) {        return(pathname);      pathname <- Arguments$getWritablePathname(filename, path=path,                                                  mustNotExist=!overwrite);    }  }  protocol <- getProtocol(this);  if (protocol == "https") {    usr <- getUsername(this);    pwd <- getPassword(this);    opts <- sprintf("--http-user=%s --http-passwd=%s", usr, pwd);  } else {    opts <- "";  }  cmd <- sprintf("wget --output-document=\"%s\" --no-check-certificate %s %s", pathname, opts, url);  print(cmd);  # Download  system(cmd);  # Remove "empty" downloads  fi <- file.info(pathname);  str(fi);  if (is.na(fi$size) || fi$size == 0) {    file.remove(pathname);    pathname <- NULL;  }  invisible(pathname);})setMethodS3("downloadFile", "TcgaDccDownloader", function(this, filename, ...) {  filename <- Arguments$getCharacter(filename);  url <- getUrl(this, filename);  print(url);  pathname <- downloadUrl(this, url, ...);    pathname;})setMethodS3("downloadFiles", "TcgaDccDownloader", function(this, pattern=NULL, ...) {  # Identify matching filenames to be downloading  filenames <- listFiles(this, pattern=pattern, ...);  print(filenames);  # Downloading each file  pathnames <- sapply(filenames, FUN=function(filename) {    print(filename);    pathname <- downloadFile(this, filename);    print(pathname);    pathname;  });  print(pathnames);  invisible(pathnames);})setMethodS3("readRows", "TcgaDccDownloader", function(con, ...) {  # To please R CMD check  this <- con;  pathname <- downloadFile(this, ...);  if (length(pathname) == 0)    return(NULL);    lines <- readLines(pathname);  attr(lines, "pathname") <- pathname;  lines;})setMethodS3("readTextFile", "TcgaDccDownloader", function(this, filename, ...) {  field <- sprintf(".%s", filename);  value <- this[[field]];  if (is.null(value)) {    value <- readRows(this, filename);    this[[field]] <- value;  }  value;})setMethodS3("readManifest", "TcgaDccDownloader", function(this, ...) {  readTextFile(this, "MANIFEST.txt");})setMethodS3("readReadme", "TcgaDccDownloader", function(this, ...) {  readTextFile(this, "README.txt");})setMethodS3("readIdf", "TcgaDccDownloader", function(this, ...) {  path <- getUrlPath(this);  filename <- listFiles(this, pattern="[.]idf[.]txt");  if (length(filename) == 0) {    throw("Cannot read IDF.  Failed to located *.idf.txt: ");  }  if (length(filename) > 2) {    throw("Cannot read IDF.  Failed to located a unique *.idf.txt: ",                                        paste(filename, collapse=", "));  }  readTextFile(this, filename);})setMethodS3("readSdrf", "TcgaDccDownloader", function(this, ...) {  path <- getUrlPath(this);  filename <- listFiles(this, pattern="[.]sdrf[.]txt");  if (length(filename) == 0) {    throw("Cannot read IDF.  Failed to located *.idf.txt: ");  }  if (length(filename) > 2) {    throw("Cannot read IDF.  Failed to located a unique *.idf.txt: ",                                        paste(filename, collapse=", "));  }  readTextFile(this, filename);})# Not requiredsetMethodS3("readDescription", "TcgaDccDownloader", function(this, ...) {  readTextFile(this, "DESCRIPTION.txt");})# Not requiredsetMethodS3("readSampleInfo", "TcgaDccDownloader", function(this, ...) {  readTextFile(this, "SampleInfo.txt");})setMethodS3("downloadCoreTextFile", "TcgaDccDownloader", function(this, ...) {  manifest <- readManifest(this);  desc <- readDescription(this);  readme <- readReadme(this);  si <- readSampleInfo(this);  idf <- readIdf(this);  sdrf <- readSdrf(this);})setMethodS3("listFiles", "TcgaDccDownloader", function(this, pattern=NULL, ...) {  if (!is.null(pattern)) {    pattern <- Arguments$getRegularExpression(pattern);  }  filenames <- readManifest(this, ...);  if (!is.null(pattern)) {    filenames <- grep(pattern=pattern, filenames, value=TRUE);  }  filenames;})setMethodS3("getArchive", "TcgaDccDownloader", function(this, ...) {  path <- getUrlPath(this);#  path <- getParent(path, depth=0);  name <- basename(path);  name;})setMethodS3("getDataType", "TcgaDccDownloader", function(this, ...) {  path <- getUrlPath(this);  path <- getParent(path, depth=1);  name <- basename(path);  name;})setMethodS3("getPlatform", "TcgaDccDownloader", function(this, ...) {  path <- getUrlPath(this);  path <- getParent(path, depth=2);  name <- basename(path);  name;})setMethodS3("getCenter", "TcgaDccDownloader", function(this, ...) {  path <- getUrlPath(this);  path <- getParent(path, depth=3);  name <- basename(path);  name;})setMethodS3("getCenterType", "TcgaDccDownloader", function(this, ...) {  path <- getUrlPath(this);  path <- getParent(path, depth=4);  name <- basename(path);  name;})setMethodS3("getTumorType", "TcgaDccDownloader", function(this, ...) {  path <- getUrlPath(this);  path <- getParent(path, depth=5);  name <- basename(path);  name;})setMethodS3("getAccessRoot", "TcgaDccDownloader", function(this, ...) {  path <- getUrlPath(this);  path <- getParent(path, depth=6);  name <- basename(path);  name;})############################################################################# HISTORY:# 2012-04-05# o Renamed readLines() to readRows().# 2009-04-18# o BUG FIX: Now the output directory passed to wget is put within double#   quotes.# o Now downloadUrl() removes pre-existing empty files by default.# o Added accessor functions for path attributes.# 2009-04-16# o Added downloadFiles().# o Added setLogin().# 2009-04-13# o Updated readIdf() and readSdrf() to locate the files via the manifest #   file.# 2009-04-07# o Created.############################################################################